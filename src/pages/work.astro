---
import Layout from '../layouts/Layout.astro';
import type { SanityDocument } from '@sanity/client';
import { sanityClient } from 'sanity:client';
import Button from '../components/Button.astro';
import ScrollReveal from '../components/ScrollReveal.astro';
import BaselineReveal from '../components/BaselineReveal.astro';
import Tag from '../components/Tag.astro';
import RightReveal from '../components/RightReveal.astro';
import ProjectPreview from '../components/ProjectPreview.astro';
import { portfolioListQuery } from '../lib/queries/portfolio';

const TAGS_QUERY = `*[_type == "tag"]{ id, text, hoverColor, order } | order(order asc)`;

const tagsData = await sanityClient.fetch<SanityDocument[]>(TAGS_QUERY);
const portfolioData = await sanityClient.fetch<SanityDocument[]>(portfolioListQuery);

const tags = tagsData.map((tag) => ({
  id: tag.id.current,
  label: tag.text,
  hoverColor: tag.hoverColor,
}));

// Transform Sanity portfolio data to match the FeaturedProject format
const projects = portfolioData.map((project) => ({
  project: {
    _id: project._id,
    title: project.title,
    slug: project.slug.current,
    hero: project.hero,
  },
  tags: project.tags?.map((tag: any) => tag.id.current) || [],
}));
---

<Layout title="Symbold | Work">
  <section id="headers" class="content-padding">
    <BaselineReveal>
      <h1 class="page-title">
        brands
        <br /> we're proud of
      </h1>
    </BaselineReveal>
    <BaselineReveal delayed>
      <div class="mt-20 py-1 text-base font-medium md:mt-20 md:text-2xl">
        Browse work by service
      </div>
    </BaselineReveal>

    <div class="mt-10 flex flex-wrap gap-4">
      <RightReveal index={0}>
        <Tag id="all" label="All" active={true} />
      </RightReveal>
      {
        tags.map((tag, index) => (
          <RightReveal index={index + 1}>
            <Tag id={tag.id} label={tag.label} active={false} hoverColor={tag.hoverColor} />
          </RightReveal>
        ))
      }
    </div>
  </section>

  <div class="edge-padding mt-20 md:mt-30">
    {
      projects.map((item) => (
        <div class="mt-4" data-tags={item.tags.join(',')}>
          <ScrollReveal>
            <ProjectPreview project={item.project} disableCursor={true} />
          </ScrollReveal>
        </div>
      ))
    }
  </div>

  <ScrollReveal>
    <h2
      class="edge-padding mx-auto mt-30 w-full text-center text-xl leading-tight font-bold md:mt-60 md:w-1/2 md:text-4xl"
    >
      We are not for everyone.
      <br />
      Symbold partners only with visionaries who value design as strategy, not decoration.
    </h2>
  </ScrollReveal>

  <div class="content-padding mt-30 flex items-center justify-center">
    <Button class="w-full md:w-auto" href="/contact">Work with us</Button>
  </div>

  <div class="content-padding">
    <hr class="mt-30 mb-10 md:mb-30" />
  </div>
</Layout>

<script>
  document.addEventListener('astro:page-load', () => {
    let selectedTags = new Set(['all']);

    function toggleProjectVisibility(projectElement: HTMLElement, isVisible: boolean) {
      const scrollAnimationChild = projectElement.querySelector(
        '[data-scroll-animation]'
      ) as HTMLElement;

      if (isVisible) {
        projectElement.style.display = 'block';
        const isInViewport = scrollAnimationChild.getBoundingClientRect().top < window.innerHeight;
        if (isInViewport) {
          scrollAnimationChild?.classList.add('visible');
        } else {
          scrollAnimationChild?.classList.remove('visible');
        }
      } else {
        projectElement.style.display = 'none';
        scrollAnimationChild?.classList.remove('visible');
      }
    }

    function renderProjects() {
      const projectElements = document.querySelectorAll('[data-tags]');

      if (selectedTags.has('all')) {
        projectElements.forEach((el) => toggleProjectVisibility(el as HTMLElement, true));
        return;
      }

      projectElements.forEach((el) => {
        const projectTags = el.getAttribute('data-tags')?.split(',') || [];
        const hasMatchingTag = projectTags.some((tag) => selectedTags.has(tag));
        const projectElement = el as HTMLElement;
        toggleProjectVisibility(projectElement, hasMatchingTag);
      });
    }

    function toggleTag(button: Element) {
      const tagId = button.getAttribute('data-tag-id');
      const isActive = button.getAttribute('data-active') === 'true';

      if (!tagId) return;

      if (tagId === 'all') {
        if (!isActive) {
          // Select "all" and deselect others
          selectedTags.clear();
          selectedTags.add('all');

          document.querySelectorAll('.tag-button').forEach((btn) => {
            const btnTagId = btn.getAttribute('data-tag-id');
            if (btnTagId === 'all') {
              btn.setAttribute('data-active', 'true');
            } else if (btn.getAttribute('data-active') === 'true') {
              btn.setAttribute('data-active', 'false');
            }
          });
        }
      } else {
        if (isActive) {
          // Deselect this tag
          button.setAttribute('data-active', 'false');
          selectedTags.delete(tagId);

          // If no tags selected, reselect "all"
          if (selectedTags.size === 0) {
            selectedTags.add('all');
            const allTag = document.querySelector('[data-tag-id="all"]');
            if (allTag) {
              allTag.setAttribute('data-active', 'true');
            }
          }
        } else {
          // Select this tag
          button.setAttribute('data-active', 'true');
          selectedTags.delete('all');
          selectedTags.add(tagId);

          // Always deselect "all" tag when selecting another tag
          const allTag = document.querySelector('[data-tag-id="all"]');
          if (allTag) {
            allTag.setAttribute('data-active', 'false');
          }
        }
      }

      renderProjects();
    }

    // Attach click handlers to all tag buttons
    document.querySelectorAll('.tag-button').forEach((button) => {
      button.addEventListener('click', () => toggleTag(button));
    });
  });
</script>
