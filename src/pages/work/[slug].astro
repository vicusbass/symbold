---
import Layout from '../../layouts/Layout.astro';
import type { SanityDocument } from '@sanity/client';
import { sanityClient } from 'sanity:client';
import Tag from '../../components/Tag.astro';
import ScrollReveal from '../../components/ScrollReveal.astro';
import ContactForm from '../../components/ContactForm.astro';
import ProjectPreview from '../../components/ProjectPreview.astro';
import ResponsiveHero from '../../components/ResponsiveHero.astro';
import MediaRenderer from '../../components/MediaRenderer.astro';
import type { FeaturedProject } from '../../types/sanity';
import { allProjectsQuery } from '../../lib/queries/portfolio';
import BaselineReveal from '../../components/BaselineReveal.astro';
import RightReveal from '../../components/RightReveal.astro';
import StyledPortableText from '../../components/StyledPortableText.astro';

export async function getStaticPaths() {
  // Fetch all projects with full details in one query

  const allProjects = await sanityClient.fetch<SanityDocument[]>(allProjectsQuery);

  return allProjects.map((project) => ({
    params: { slug: project.slug.current },
    props: {
      project,
      allProjects,
    },
  }));
}

const { project, allProjects } = Astro.props;

if (!project) {
  throw new Error('Project not found.');
}

// Get current project's tag IDs
const currentProjectTagIds = project.tags?.map((tag: any) => tag.id.current) || [];

// Filter projects that share at least one tag with current project
const projectsWithMatchingTags = allProjects.filter((p: any) => {
  if (p._id === project._id) return false; // Exclude current project
  const projectTagIds = p.tags?.map((tag: any) => tag.id.current) || [];
  return projectTagIds.some((tagId: string) => currentProjectTagIds.includes(tagId));
});

// Select 3 random projects from matching projects - changes on every page load
const shuffled = projectsWithMatchingTags.sort(() => 0.5 - Math.random());
const suggestedProjects: FeaturedProject[] = shuffled.slice(0, 3).map((p: any) => ({
  _id: p._id,
  title: p.title,
  slug: p.slug.current,
  hero: p.hero,
}));

const heroLabelledTags =
  project.tags?.map((tag: any) => ({
    id: tag.id.current,
    label: tag.text,
    hoverColor: tag.hoverColor,
  })) || [];

const teamLines = Array.isArray(project.team) ? project.team : [];
---

<Layout title={`Symbold | ${project.title}`}>
  <section class="content-padding">
    <div class="flex flex-col md:flex-row">
      <div class="md:w-3/4 md:pr-[10vw]">
        <BaselineReveal>
          <h1 class="page-title">{project.title}</h1>
        </BaselineReveal>
        <BaselineReveal delayed>
          <div class="mt-20 py-1 text-base font-medium md:mt-20 md:text-2xl">
            {project.description}
          </div>
        </BaselineReveal>
        <div class="mt-10 flex flex-wrap gap-4">
          {
            heroLabelledTags.map(
              (
                tag: { id: string; label: string; hoverColor: { hex?: string } | undefined },
                index: number
              ) => (
                <RightReveal index={index + 1}>
                  <Tag id={tag.id} label={tag.label} active={false} hoverColor={tag.hoverColor} />
                </RightReveal>
              )
            )
          }
        </div>
      </div>
      <div class="mt-5 flex min-w-70 flex-col justify-end md:mt-0">
        <BaselineReveal delayed>
          <h2 class="text-base font-semibold">Team:</h2>
          <div class="mt-1 text-base font-semibold text-gray-400">
            {teamLines.map((line) => <p>{line}</p>)}
          </div>
        </BaselineReveal>
      </div>
    </div>
  </section>

  <section class="edge-padding mt-16 md:mt-24">
    <MediaRenderer media={project.hero} videoTitle={project.title} />
  </section>

  <section class="edge-padding">
    {
      project.content?.map((row: any) => {
        // portfolioRowFull - Full width responsive media
        if (row._type === 'portfolioRowFull') {
          return (
            <article class="mt-4">
              <ScrollReveal>
                <ResponsiveHero
                  desktopMedia={{
                    mediaType: row.desktopMedia.mediaType,
                    image: row.desktopMedia.image,
                    video: row.desktopMedia.video,
                  }}
                  mobileMedia={{
                    mediaType: row.mobileMedia.mediaType,
                    image: row.mobileMedia.image,
                    video: row.mobileMedia.video,
                  }}
                  videoTitle={project.title}
                />
              </ScrollReveal>
            </article>
          );
        }

        // portfolioRowWithDescription - Media with description
        if (row._type === 'portfolioRowWithDescription') {
          const description = row.description;
          const isDescriptionLeft = row.descriptionPosition === 'left';

          const mediaOrderClasses = isDescriptionLeft ? 'order-2 md:order-2' : 'order-1 md:order-1';
          const descriptionOrderClasses = isDescriptionLeft
            ? 'order-1 md:pr-10'
            : 'order-2 md:pl-10';

          return (
            <article class="mt-4 flex flex-col gap-8 md:flex-row md:items-center md:gap-4">
              <div class={`w-full md:w-1/2 ${mediaOrderClasses}`}>
                <ScrollReveal>
                  <MediaRenderer media={row.media} videoTitle={project.title} />
                </ScrollReveal>
              </div>
              {description && description.length > 0 && (
                <div
                  class={`w-full text-base leading-relaxed md:w-1/2 md:text-lg ${descriptionOrderClasses}`}
                >
                  <ScrollReveal>
                    <div class="md:px-16">
                      <StyledPortableText value={description} />
                    </div>
                  </ScrollReveal>
                </div>
              )}
            </article>
          );
        }

        // portfolioRowSplit - Two media items side by side
        if (row._type === 'portfolioRowSplit') {
          return (
            <article class="mt-4 flex flex-col gap-4 md:flex-row">
              <div class="w-full md:w-1/2">
                <ScrollReveal>
                  <MediaRenderer media={row.leftMedia} videoTitle={project.title} />
                </ScrollReveal>
              </div>
              <div class="w-full md:w-1/2">
                <ScrollReveal>
                  <MediaRenderer media={row.rightMedia} videoTitle={project.title} />
                </ScrollReveal>
              </div>
            </article>
          );
        }

        // portfolioRowText - Text only block
        if (row._type === 'portfolioRowText') {
          return (
            <article class="mt-40 mb-40">
              <ScrollReveal>
                <div class="md:flex md:justify-center">
                  <div class="max-w-3xl text-base leading-relaxed md:text-lg">
                    <StyledPortableText value={row.text} />
                  </div>
                </div>
              </ScrollReveal>
            </article>
          );
        }

        return null;
      })
    }
  </section>

  {
    suggestedProjects.length ? (
      <section class="content-padding mt-30 md:mt-40">
        <h2 class="text-3xl font-bold tracking-tighter md:text-5xl">Suggested projects</h2>
        <div class="mt-10 grid gap-4 md:grid-cols-3">
          {suggestedProjects.map((suggested) => (
            <ScrollReveal>
              <ProjectPreview project={suggested} disableCursor={true} />
            </ScrollReveal>
          ))}
        </div>
      </section>
    ) : null
  }

  <section class="content-padding mt-30 md:mt-40">
    <div class="flex flex-col gap-12 md:flex-row md:items-start md:gap-20">
      <div class="w-full md:w-1/3">
        <h2 class="text-3xl font-bold md:text-5xl">Let's talk about you.</h2>
      </div>
      <ContactForm wrapperClass="md:w-[55.67%]" />
    </div>
  </section>

  <div class="edge-padding">
    <hr class="mt-30 mb-10 md:mb-30" />
  </div>
</Layout>
