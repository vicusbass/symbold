---
import Logo from '../assets/logo.svg';
import MenuIcon from '../assets/menu.svg';
import MenuCloseIcon from '../assets/menu-close.svg';

const menuItems = [
  { name: 'home', href: '/' },
  { name: 'work', href: '/work' },
  { name: 'about', href: '/about' },
  { name: 'contact', href: '/contact' },
];
---

<header class="content-padding z-50 flex h-[76px] items-center justify-between">
  <div class="logo">
    <a href="/">
      <Logo class="h-auto w-auto" />
    </a>
  </div>
  <!-- Desktop Navigation -->
  <nav class="hidden items-center gap-6 md:flex">
    {
      menuItems.map((item) => (
        <a href={item.href} class="nav-link text-base font-medium uppercase" data-href={item.href}>
          {item.name}
        </a>
      ))
    }
  </nav>

  <!-- Mobile Hamburger -->
  <button
    id="menu-toggle"
    class="relative flex h-8 w-8 items-center justify-center md:hidden"
    aria-label="Toggle menu"
    aria-expanded="false"
  >
    <MenuIcon class="menu-icon h-8 w-8 transition-all duration-300" />
    <MenuCloseIcon class="close-icon absolute h-8 w-8 transition-all duration-300" />
  </button>
</header>

<style>
  .nav-link {
    position: relative;
    transition: color 0.3s ease;
  }

  .nav-link::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: var(--color-accent);
    transform: scaleX(0);
    transition: transform 0.3s ease;
  }

  .nav-link:hover::after {
    transform: scaleX(1);
  }

  .nav-link.active::after {
    transform: scaleX(1);
  }

  .menu-icon {
    opacity: 1;
    transform: rotate(0deg);
  }

  .close-icon {
    opacity: 0;
    transform: rotate(-90deg);
  }

  [aria-expanded='true'] .menu-icon {
    opacity: 0;
    transform: rotate(90deg);
  }

  [aria-expanded='true'] .close-icon {
    opacity: 1;
    transform: rotate(0deg);
  }

  #mobile-menu {
    z-index: 40;
    transform: scale(0.1);
    opacity: 0.9;
    /* dynamic transform-origin set via JS each open */
    transform-origin: top right;
    transition:
      opacity 0.4s ease-out,
      transform 0.4s ease-out;
    will-change: opacity, transform;
  }

  #mobile-menu.active {
    opacity: 1;
    transform: scale(1);
  }
</style>

<!-- Mobile Menu -->
<nav id="mobile-menu" class="fixed inset-0 z-50 flex hidden flex-col justify-end bg-white p-8">
  {
    menuItems.map((item) => (
      <a
        href={item.href}
        data-mi={item.href}
        class="block overflow-hidden pb-4 text-6xl leading-12 font-[1000]"
      >
        {item.name}
      </a>
    ))
  }
</nav>

<script>
  document.addEventListener('astro:page-load', () => {
    // Mark active desktop nav link
    const desktopNavLinks = document.querySelectorAll('.nav-link[data-href]');
    desktopNavLinks.forEach((link) => {
      if (document.location.pathname === link.getAttribute('href')) {
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });

    // Mark active mobile menu link
    const mobileMenuLinks = document.querySelectorAll('#mobile-menu a[data-mi]');
    mobileMenuLinks.forEach((link) => {
      if (document.location.pathname === link.getAttribute('href'))
        link.classList.add('text-accent');
      else link.classList.add('text-black');
    });

    const menuToggle = document.getElementById('menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    if (!menuToggle || !mobileMenu) return;

    const openMenu = () => {
      if (mobileMenu) {
        // reveal first so transition can play
        mobileMenu.classList.remove('hidden');
        // force reflow to ensure transition starts
        void mobileMenu.offsetWidth;
        mobileMenu.classList.add('active');
        // Lock body scroll
        const scrollY = window.scrollY;
        document.body.dataset.scrollLockY = scrollY.toString();
        document.body.style.position = 'fixed';
        document.body.style.top = `-${scrollY}px`;
        document.body.style.left = '0';
        document.body.style.right = '0';
        document.body.style.width = '100%';
        document.body.style.overflow = 'hidden';
      }
    };

    const closeMenu = () => {
      if (mobileMenu) {
        mobileMenu.classList.remove('active');
        // after transition hide completely
        // @ts-ignore - runtime JS only, event typing not required
        const handleTransitionEnd = (e) => {
          if (e.target === mobileMenu && e.propertyName === 'opacity') {
            mobileMenu.classList.add('hidden');
            mobileMenu.removeEventListener('transitionend', handleTransitionEnd);
            // Restore body scroll
            const lockedY = parseInt(document.body.dataset.scrollLockY || '0', 10);
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.right = '';
            document.body.style.width = '';
            document.body.style.overflow = '';
            // Restore scroll position
            window.scrollTo(0, lockedY);
            delete document.body.dataset.scrollLockY;
          }
        };
        mobileMenu.addEventListener('transitionend', handleTransitionEnd);
      }
    };

    menuToggle.addEventListener('click', () => {
      const isExpanded = menuToggle.getAttribute('aria-expanded') === 'true';
      const nextExpanded = (!isExpanded).toString();
      menuToggle.setAttribute('aria-expanded', nextExpanded);

      if (nextExpanded === 'true') {
        openMenu();
      } else {
        closeMenu();
      }
    });
  });
</script>
