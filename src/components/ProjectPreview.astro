---
import { Image } from 'astro:assets';
import MuxVideo from './MuxVideo.astro';
import { urlFor } from '../lib/sanity';
import type { FeaturedProject } from '../types/sanity';

interface Props {
  project: FeaturedProject;
  textColor?: string;
  class?: string;
  disableCursor?: boolean;
}

const { project, textColor = '#FFFFFF', class: className, disableCursor = false } = Astro.props;

const imageUrl =
  project.hero?.mediaType === 'image' && project.hero.image
    ? urlFor(project.hero.image)?.url()
    : null;
const videoPlaybackId =
  project.hero?.mediaType === 'video' && project.hero.video?.asset?.playbackId
    ? project.hero.video.asset.playbackId
    : null;
const alt = project.hero?.image?.alt || project.title || '';
---

<a
  href={`/work/${project.slug}`}
  class:list={[
    !disableCursor && 'project-preview-link',
    'group focus-visible:ring-accent block focus:outline-none focus-visible:ring-2',
    className,
  ]}
>
  {project.title && <h3 class="mb-2 text-base font-bold md:hidden">{project.title}</h3>}
  <div class="relative aspect-video overflow-hidden rounded-md">
    {
      imageUrl ? (
        <Image src={imageUrl} alt={alt} class="h-full w-full object-cover" inferSize />
      ) : videoPlaybackId ? (
        <MuxVideo
          playbackId={videoPlaybackId}
          videoTitle={project.title}
          enforceAspectRatio={true}
        />
      ) : null
    }
    {
      project.title && (
        <div class="absolute inset-0 hidden items-start justify-start rounded-md p-4 opacity-0 transition-opacity duration-300 group-hover:opacity-100 md:flex md:bg-black/20">
          <p
            class="max-w-[50%] text-xl font-bold"
            style={{
              color: textColor,
            }}
          >
            {project.title}
          </p>
        </div>
      )
    }
  </div>
  <slot />
</a>

<style is:global>
  @media (min-width: 768px) {
    .project-preview-link {
      cursor: none !important;
    }
  }

  #custom-cursor {
    position: fixed;
    pointer-events: none;
    z-index: 9999;
    opacity: 0;
    transform: translate(-50%, -50%);
    width: 64px;
    height: 64px;
    display: none;
  }

  @media (min-width: 768px) {
    #custom-cursor {
      display: block;
    }
  }

  #custom-cursor.active {
    opacity: 1;
    transition: opacity 0.5s ease;
  }

  #custom-cursor svg {
    width: 100%;
    height: 100%;
    color: #44ff00;
  }
</style>

<script>
  import eyeIconSvg from '../assets/ochi.svg?raw';

  function initializeCursor() {
    // Create or get the custom cursor element
    let customCursor = document.getElementById('custom-cursor');
    if (!customCursor) {
      customCursor = document.createElement('div');
      customCursor.id = 'custom-cursor';
      customCursor.innerHTML = eyeIconSvg;
      document.body.appendChild(customCursor);
    }

    // Mouse move handler for the entire document
    const handleMouseMove = (e: MouseEvent) => {
      if (customCursor) {
        customCursor.style.left = `${e.clientX}px`;
        customCursor.style.top = `${e.clientY}px`;
      }
    };

    document.addEventListener('mousemove', handleMouseMove);

    return customCursor;
  }

  function attachCursorListeners(customCursor: HTMLElement) {
    const links = document.querySelectorAll('.project-preview-link');

    links.forEach((link) => {
      // remove old attribute to allow reattachment (important for cloned nodes)
      if (link.hasAttribute('data-cursor-attached')) {
        link.removeAttribute('data-cursor-attached');
      }

      link.setAttribute('data-cursor-attached', 'true');

      link.addEventListener('mouseenter', () => {
        if (customCursor) {
          customCursor.classList.add('active');
        }
      });

      link.addEventListener('mouseleave', () => {
        if (customCursor) {
          customCursor.classList.remove('active');
        }
      });
    });
  }

  document.addEventListener('astro:page-load', () => {
    // Only initialize cursor if there are project preview links on the page
    const hasProjectLinks = document.querySelectorAll('.project-preview-link').length > 0;

    if (hasProjectLinks) {
      const customCursor = initializeCursor();
      attachCursorListeners(customCursor);

      // Listen for dynamic project renders (e.g., from work page filtering)
      document.addEventListener('projects-rendered', () => {
        attachCursorListeners(customCursor);
      });
    }
  });
</script>
